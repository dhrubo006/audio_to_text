<!DOCTYPE html>
<html>
<head>
    <title>Audio Transcription and Response Generator</title>
</head>
<body>

    <h3>Upload or Record Audio for Transcription</h3>

    <!-- Form for uploading audio files from the user's device -->
    <form id="uploadForm" action="/uploader" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" accept="audio/*" />
        <input type="submit" value="Upload Audio File" />
    </form>
    <br>

    <!-- Section for recording audio directly in the browser -->
    <form id="recordForm">
        <button type="button" id="startRecord">Start Recording</button>
        <button type="button" id="stopRecord" disabled>Stop Recording</button>
        <button type="button" id="submitRecord" disabled>Submit Recording</button>
        <br><br>
        <audio id="audio" controls></audio>
    </form>

    <!-- Div elements for displaying the transcription and generated response -->
    <div id="transcription"></div>
    <div id="response"></div>

    <script>
        // Variables for managing audio recording
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;

        // Function to use speech synthesis to read text aloud
        function speak(text) {
            let utterance = new SpeechSynthesisUtterance(text);
            utterance.pitch = 1; // Default pitch
            utterance.rate = 1;  // Default rate
            utterance.volume = 1; // Default volume
            window.speechSynthesis.speak(utterance);
        }

        // Function to handle sending audio data to the server and processing the response
        function sendAudioToServer(formData) {
            fetch('/uploader', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json()) // Convert response to JSON
            .then(data => {
                // Display the transcription and response
                document.getElementById('transcription').innerText = 'Transcription: ' + data.transcription;
                document.getElementById('response').innerText = 'Response: ' + data.response;
                // Read the transcription and response aloud
                speak(data.transcription);
                speak(data.response);
            })
            .catch(error => console.error('Error:', error)); // Handle any errors
        }

        // Event listener for the audio file upload form
        document.getElementById("uploadForm").addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent default form submission
            const formData = new FormData(this); // Create FormData from form
            sendAudioToServer(formData); // Send the audio file to the server
        });

        // Event listener for starting audio recording
        document.getElementById("startRecord").addEventListener("click", function () {
            navigator.mediaDevices.getUserMedia({ audio: true }) // Request access to the microphone
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream); // Create a MediaRecorder with the stream
                    document.getElementById("stopRecord").disabled = false; // Enable the stop recording button
                    mediaRecorder.start(); // Start recording
                    audioChunks = []; // Initialize the audio chunks array

                    // Collect audio data chunks during recording
                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    // Actions to take after recording is stopped
                    mediaRecorder.addEventListener("stop", () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // Create a blob from the chunks
                        const audioUrl = URL.createObjectURL(audioBlob); // Create a URL for the blob
                        const audio = document.getElementById("audio"); // Get the audio playback element
                        audio.src = audioUrl; // Set the blob URL as the audio source
                        document.getElementById("submitRecord").disabled = false; // Enable the submit recording button
                    });
                })
                .catch(error => console.error("Error accessing media devices.", error)); // Handle errors in accessing the microphone
        });

        // Event listener for stopping audio recording
        document.getElementById("stopRecord").addEventListener("click", function () {
            mediaRecorder.stop(); // Stop recording
            document.getElementById("stopRecord").disabled = true; // Disable the stop recording button
        });

        // Event listener for submitting the audio recording
        document.getElementById("submitRecord").addEventListener("click", function () {
            const formData = new FormData(); // Create a new FormData object
            formData.append("file", audioBlob, "recording.wav"); // Append the audio blob to the FormData
            sendAudioToServer(formData); // Send the audio recording to the server
        });
    </script>

</body>
</html>
